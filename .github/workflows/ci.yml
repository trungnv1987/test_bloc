# CI workflow using Fastlane for Flutter project
# This workflow runs tests, builds APK/AAB for Android and iOS app
name: CI with Fastlane

# Define when this workflow should be triggered
on:
  push:
    branches: [main, develop] # Run on push to main or develop branches
  pull_request:
    branches: [main, develop] # Run on PRs targeting main or develop branches
  workflow_dispatch: # Allow manual trigger
    inputs:
      flutter_version:
        description: "Flutter version to use (overrides default)"
        required: false
        default: "3.35.4"

jobs:
  build-ios-dev:
    name: build-ios-dev
    runs-on: macos-latest # iOS builds require macOS runner
    # needs: test # Only run after test job passes

    steps:
      # Checkout the repository code
      - name: Checkout repository
        uses: actions/checkout@v4

      # Set Flutter version from environment if input is empty
      - name: Set Flutter version from environment
        if: ${{ inputs.flutter_version == '' }}
        run: echo "FLUTTER_VERSION=${{ env.FLUTTER_VERSION }}" >> $GITHUB_ENV

      # Setup Ruby for Fastlane
      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.3"
          bundler-cache: true

      # Setup Flutter SDK
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }} # Use Flutter version from environment
          channel: "stable"
          cache: true

      # Install Fastlane dependencies
      - name: Install Fastlane
        run: bundle install

      # Run full CI pipeline for iOS (deps, analyze, test, build)
      - name: Build iOS dev with Fastlane
        run: |
          cd ios
          bundle exec fastlane build_dev

      # Upload iOS app bundle as build artifact
      # - name: Upload iOS artifact
      #   uses: actions/upload-artifact@v4
      #   with:
      #     name: ios-release-${{ github.sha }} # Unique name with commit SHA
      #     path: build/ios/iphoneos/Runner.app # iOS app bundle location
